<div class="page-container">
  <div class="page-header">
    <div>
      <h1>Secondary Marketplace</h1>
      <p class="subtitle">Purchase existing loan investments from other lenders.</p>
    </div>
    <!-- (Optional but recommended) Add sorting controls -->
    <mat-form-field appearance="outline" class="sort-dropdown" *ngIf="listings.length > 0">
      <mat-label>Sort By</mat-label>
      <mat-select (selectionChange)="sortListings($event.value)" value="price-asc">
        <mat-option value="price-asc">Price: Low to High</mat-option>
        <mat-option value="price-desc">Price: High to Low</mat-option>
        <mat-option value="risk-asc">Risk: Low to High</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="state-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading active listings...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && listings.length === 0" class="state-container">
    <mat-icon class="empty-icon">store_mall_directory</mat-icon>
    <h2>Marketplace is Empty</h2>
    <p>There are currently no investments listed for sale. Please check back later.</p>
  </div>

  <!-- Data State: Listing Grid -->
  <div *ngIf="!isLoading && listings.length > 0" class="listing-grid">
    <mat-card 
      *ngFor="let listing of listings" 
      class="listing-card" 
      (click)="viewLoanDetails(listing.investment.loan.loanId)" 
      matTooltip="Click to see details of the underlying loan">
      
      <div class="card-header">
        <h3 class="price">{{ listing.listingPrice | currency:'USD' }}</h3>
        <div class="risk-tag" [ngClass]="'risk-' + listing.investment.loan.riskScore">
          Risk: {{ listing.investment.loan.riskScore }}
        </div>
      </div>
      
      <mat-card-content>
        <div class="principal-info">
          <span>Remaining Principal: {{ listing.remainingPrincipal | currency:'USD' }}</span>
          <!-- Calculate and display discount or premium -->
          <ng-container *ngIf="listing.listingPrice - listing.remainingPrincipal as diff">
            <span *ngIf="diff !== 0" class="discount-premium" [ngClass]="diff < 0 ? 'discount' : 'premium'">
              {{ diff < 0 ? 'Discount: ' : 'Premium: ' }} {{ diff | currency:'USD' }}
            </span>
          </ng-container>
        </div>
        
        <mat-divider></mat-divider>
        
        <div class="loan-details">
          <h4>Loan Details</h4>
          <ul>
            <li>
              <mat-icon>trending_up</mat-icon>
              <span>Interest Rate:</span>
              <strong>{{ listing.investment.loan.interestRate / 100 | percent:'1.2-2' }} APR</strong>
            </li>
            <li>
              <mat-icon>schedule</mat-icon>
              <span>Original Term:</span>
              <strong>{{ listing.investment.loan.termMonths }} Months</strong>
            </li>
          </ul>
        </div>
      </mat-card-content>
      
      <mat-card-actions class="card-actions">
        <button mat-flat-button color="primary" (click)="buyListing(listing.listingId, $event)">
          <mat-icon>shopping_cart</mat-icon>
          Buy Investment
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>